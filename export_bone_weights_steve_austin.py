import bpy
import os
from bpy_extras.io_utils import ImportHelper
from bpy.props import StringProperty

# Bone name to ID map from 3ds Max (abbreviated for clarity)
bone_name_to_max_id = {
    "m007_0201": 0,
    "m007_0101": 1,
    "m000_0103": 2,
    "J_Clavicle_L": 3,
    "J_Head": 4,
    "J_Neck": 5,
    "J_Chest": 6,
    "m000_0203": 7,
    "m027_0103": 8,
    "m007_0200": 9,
    "m007_0100": 10,
    "m000_0303": 11,
    "H_Neck_tw": 12,
    "m027_0003": 13,
    "m007_0002": 14,
    "m007_0001": 15,
    "m007_0000": 16,
    "m000_0003": 17,
    "m000_0102": 18,
    "m029_0301": 19,
    "m029_0302": 20,
    "m000_0002": 21,
    "m029_0300": 22,
    "m000_0202": 23,
    "m027_0203": 24,
    "m000_0302": 25,
    "m009_0303": 26,
    "m009_0302": 27,
    "m025_0003": 28,
    "m007_0202": 29,
    "m007_0102": 30,
    "m026_0201": 31,
    "m026_0101": 32,
    "m009_0103": 33,
    "J_Clavicle_R": 34,
    "m026_0100": 35,
    "m025_0103": 36,
    "m026_0200": 37,
    "m009_0203": 38,
    "m026_0002": 39,
    "m026_0001": 40,
    "m026_0000": 41,
    "m009_0003": 42,
    "m010_0301": 43,
    "m009_0102": 44,
    "m010_0302": 45,
    "m009_0002": 46,
    "m010_0300": 47,
    "m009_0202": 48,
    "m025_0203": 49,
    "m026_0202": 50,
    "m026_0102": 51,
    "m029_0200": 52,
    "m028_0102": 53,
    "m001_0001": 54,
    "m001_0000": 55,
    "J_Spine2": 56,
    "m001_0100": 57,
    "m030_0001": 58,
    "m029_0100": 59,
    "m028_0002": 60,
    "H_Delt_L_OS01": 61,
    "m029_0000": 62,
    "m028_0100": 63,
    "m028_0000": 64,
    "m027_0300": 65,
    "m005_0303": 66,
    "J_Spine1": 67,
    "m027_0200": 68,
    "m028_0200": 69,
    "m005_0302": 70,
    "m028_0101": 71,
    "m001_0101": 72,
    "m000_0300": 73,
    "m000_0200": 74,
    "m028_0202": 75,
    "m000_0100": 76,
    "m030_0201": 77,
    "m027_0301": 78,
    "m030_0200": 79,
    "m030_0101": 80,
    "m028_0001": 81,
    "m030_0202": 82,
    "J_Hips": 83,
    "m028_0300": 84,
    "m028_0301": 85,
    "m011_0301": 86,
    "m011_0300": 87,
    "m028_0302": 88,
    "m009_0300": 89,
    "m000_0301": 90,
    "m009_0301": 91,
    "m000_0201": 92,
    "m000_0101": 93,
    "m027_0002": 94,
    "m027_0001": 95,
    "m025_0002": 96,
    "m025_0001": 97,
    "m005_0203": 98,
    "m005_0103": 99,
    "m027_0000": 100,
    "m025_0000": 101,
    "m005_0202": 102,
    "m005_0102": 103,
    "m005_0201": 104,
    "m005_0101": 105,
    "m005_0200": 106,
    "m005_0100": 107,
    "m028_0201": 108,
    "m000_0000": 109,
    "m000_0001": 110,
    "m027_0303": 111,
    "m027_0302": 112,
    "m027_0202": 113,
    "m029_0202": 114,
    "m027_0102": 115,
    "m027_0101": 116,
    "m027_0100": 117,
    "m027_0201": 118,
    "m005_0301": 119,
    "m005_0300": 120,
    "m020_0202": 121,
    "m020_0102": 122,
    "m020_0002": 123,
    "m012_0303": 124,
    "m012_0203": 125,
    "m030_0002": 126,
    "m030_0000": 127,
    "m029_0102": 128,
    "m029_0002": 129,
    "m030_0100": 130,
    "m030_0102": 131,
    "m024_0001": 132,
    "m024_0000": 133,
    "m011_0102": 134,
    "m010_0200": 135,
    "m011_0002": 136,
    "m010_0100": 137,
    "H_Delt_R_OS01": 138,
    "m023_0001": 139,
    "m024_0100": 140,
    "m010_0000": 141,
    "m025_0300": 142,
    "m011_0100": 143,
    "m011_0000": 144,
    "m005_0003": 145,
    "m025_0200": 146,
    "m011_0200": 147,
    "m005_0002": 148,
    "m011_0101": 149,
    "m024_0101": 150,
    "m009_0200": 151,
    "m011_0202": 152,
    "m009_0100": 153,
    "m023_0201": 154,
    "m025_0301": 155,
    "m023_0101": 156,
    "m023_0200": 157,
    "m011_0001": 158,
    "m023_0202": 159,
    "m011_0302": 160,
    "m009_0201": 161,
    "m009_0101": 162,
    "m011_0201": 163,
    "m009_0000": 164,
    "m009_0001": 165,
    "m025_0303": 166,
    "m025_0302": 167,
    "m025_0202": 168,
    "m010_0202": 169,
    "m025_0102": 170,
    "m025_0101": 171,
    "m025_0100": 172,
    "m025_0201": 173,
    "m005_0001": 174,
    "m005_0000": 175,
    "m021_0202": 176,
    "m021_0102": 177,
    "m021_0002": 178,
    "m016_0303": 179,
    "m016_0203": 180,
    "m023_0002": 181,
    "m023_0000": 182,
    "m010_0102": 183,
    "m010_0002": 184,
    "m023_0100": 185,
    "m023_0102": 186,
    "m006_0201": 187,
    "m006_0101": 188,
    "m006_0200": 189,
    "m006_0100": 190,
    "H_Ebw_In_L": 191,
    "J_Elbow_L": 192,
    "J_Shoulder_L": 193,
    "m006_0202": 194,
    "m006_0102": 195,
    "H_Elbow_L_tw02": 196,
    "H_Elbow_L_tw01": 197,
    "m006_0001": 198,
    "m006_0000": 199,
    "m002_0302": 200,
    "m002_0202": 201,
    "m002_0201": 202,
    "m002_0301": 203,
    "H_Ebw_Out_L": 204,
    "m003_0201": 205,
    "m003_0101": 206,
    "H_TrapBase_L": 207,
    "m003_0001": 208,
    "m029_0201": 209,
    "m029_0101": 210,
    "m003_0200": 211,
    "m003_0100": 212,
    "m029_0001": 213,
    "m002_0200": 214,
    "m002_0100": 215,
    "m002_0300": 216,
    "m002_0101": 217,
    "m002_0102": 218,
    "m003_0000": 219,
    "m002_0000": 220,
    "m002_0001": 221,
    "m002_0002": 222,
    "m006_0002": 223,
    "J_Wrist_L": 224,
    "m015_0201": 225,
    "m015_0101": 226,
    "m015_0200": 227,
    "m015_0100": 228,
    "H_Ebw_In_R": 229,
    "J_Elbow_R": 230,
    "J_Shoulder_R": 231,
    "m015_0202": 232,
    "m015_0102": 233,
    "H_Elbow_R_tw02": 234,
    "H_Elbow_R_tw01": 235,
    "m015_0001": 236,
    "m015_0000": 237,
    "m014_0302": 238,
    "m014_0202": 239,
    "m014_0201": 240,
    "m014_0301": 241,
    "H_Ebw_Out_R": 242,
    "m013_0201": 243,
    "m013_0101": 244,
    "H_TrapBase_R": 245,
    "m013_0001": 246,
    "m010_0201": 247,
    "m010_0101": 248,
    "m013_0200": 249,
    "m013_0100": 250,
    "m010_0001": 251,
    "m014_0300": 252,
    "m014_0200": 253,
    "m014_0100": 254,
    "m014_0101": 255,
    "m014_0102": 256,
    "m013_0000": 257,
    "m014_0000": 258,
    "m014_0001": 259,
    "m014_0002": 260,
    "m015_0002": 261,
    "J_Wrist_R": 262,
    "J_PinkyF0_L": 263,
    "J_ThumbF1_L": 264,
    "J_MiddleF0_L": 265,
    "J_RingF0_L": 266,
    "J_IndexF0_L": 267,
    "J_MiddleF1_L": 268,
    "J_RingF1_L": 269,
    "J_MiddleF3_L": 270,
    "J_IndexF1_L": 271,
    "J_MiddleF2_L": 272,
    "J_IndexF3_L": 273,
    "J_IndexF2_L": 274,
    "J_RingF3_L": 275,
    "J_PinkyF1_L": 276,
    "J_RingF2_L": 277,
    "J_PinkyF3_L": 278,
    "J_PinkyF2_L": 279,
    "J_ThumbF3_L": 280,
    "J_ThumbF2_L": 281,
    "J_PinkyF0_R": 282,
    "J_ThumbF1_R": 283,
    "J_MiddleF0_R": 284,
    "J_RingF0_R": 285,
    "J_IndexF0_R": 286,
    "J_MiddleF1_R": 287,
    "J_RingF1_R": 288,
    "J_MiddleF3_R": 289,
    "J_IndexF1_R": 290,
    "J_MiddleF2_R": 291,
    "J_IndexF3_R": 292,
    "J_IndexF2_R": 293,
    "J_RingF3_R": 294,
    "J_PinkyF1_R": 295,
    "J_RingF2_R": 296,
    "J_PinkyF3_R": 297,
    "J_PinkyF2_R": 298,
    "J_ThumbF3_R": 299,
    "J_ThumbF2_R": 300,
    "m020_0201": 301,
    "m019_0003": 302,
    "m019_0002": 303,
    "H_Leg_Vol_C_L": 304,
    "m019_0102": 305,
    "m019_0001": 306,
    "H_Hip_L_OS1": 307,
    "m019_0101": 308,
    "m019_0203": 309,
    "m019_0103": 310,
    "m019_0202": 311,
    "m019_0201": 312,
    "m012_0103": 313,
    "m012_0003": 314,
    "m012_0102": 315,
    "m012_0002": 316,
    "H_Hip_R_OS1": 317,
    "m016_0003": 318,
    "m016_0002": 319,
    "m019_0301": 320,
    "m019_0300": 321,
    "m019_0200": 322,
    "m022_0301": 323,
    "m022_0300": 324,
    "m020_0101": 325,
    "m012_0302": 326,
    "m019_0000": 327,
    "m020_0200": 328,
    "m020_0100": 329,
    "m019_0100": 330,
    "m019_0302": 331,
    "m022_0302": 332,
    "m022_0201": 333,
    "m022_0202": 334,
    "m019_0303": 335,
    "m022_0303": 336,
    "m022_0203": 337,
    "m016_0103": 338,
    "m012_0202": 339,
    "m020_0001": 340,
    "m022_0003": 341,
    "m022_0002": 342,
    "m021_0201": 343,
    "H_Leg_Vol_C_R": 344,
    "m022_0001": 345,
    "m022_0102": 346,
    "m022_0101": 347,
    "m022_0103": 348,
    "m016_0102": 349,
    "m022_0200": 350,
    "m021_0101": 351,
    "m016_0302": 352,
    "m021_0100": 353,
    "m022_0000": 354,
    "m021_0200": 355,
    "m022_0100": 356,
    "m016_0202": 357,
    "m021_0001": 358,
    "J_Foot_L": 359,
    "J_Knee_L": 360,
    "m004_0000": 361,
    "m004_0100": 362,
    "m004_0200": 363,
    "m004_0201": 364,
    "m004_0101": 365,
    "m004_0001": 366,
    "m004_0002": 367,
    "m008_0000": 368,
    "m004_0102": 369,
    "m008_0100": 370,
    "m004_0202": 371,
    "m008_0200": 372,
    "m008_0001": 373,
    "m008_0101": 374,
    "m008_0201": 375,
    "J_Leg_L": 376,
    "H_Kn_L_OS01": 377,
    "m012_0000": 378,
    "m012_0100": 379,
    "m012_0200": 380,
    "m012_0300": 381,
    "H_Kn_L_OS02": 382,
    "m008_0202": 383,
    "m008_0002": 384,
    "m008_0102": 385,
    "m012_0001": 386,
    "m012_0101": 387,
    "m012_0201": 388,
    "m012_0301": 389,
    "m020_0000": 390,
    "J_Foot_R": 391,
    "J_Knee_R": 392,
    "m018_0000": 393,
    "m018_0100": 394,
    "m018_0200": 395,
    "m018_0201": 396,
    "m018_0101": 397,
    "m018_0001": 398,
    "m018_0002": 399,
    "m017_0000": 400,
    "m018_0102": 401,
    "m017_0100": 402,
    "m018_0202": 403,
    "m017_0200": 404,
    "m017_0001": 405,
    "m017_0101": 406,
    "m017_0201": 407,
    "J_Leg_R": 408,
    "H_Kn_R_OS01": 409,
    "m016_0000": 410,
    "m016_0100": 411,
    "m016_0200": 412,
    "m016_0300": 413,
    "H_Kn_R_OS02": 414,
    "m017_0202": 415,
    "m017_0002": 416,
    "m017_0102": 417,
    "m016_0001": 418,
    "m016_0101": 419,
    "m016_0201": 420,
    "m016_0301": 421,
    "m021_0000": 422,
    "J_Toe_R": 423,
    "J_Toe_L": 424,
    "J_Eye_L": 425,
    "J_Eye_R": 426,
    "J_Jaw": 427,
    "J_Tongue3": 428,
    "J_Tongue2": 429,
    "J_Tongue1": 430,
    "J_Tongue4": 431
}


class ExportWeightsSteveAustin(bpy.types.Operator, ImportHelper):
    bl_idname = "export_weights.steve_austin"
    bl_label = "Export Bone Weights (Steve Austin)"
    filename_ext = ""
    use_filter_folder = True
    directory: StringProperty(subtype='DIR_PATH')

    def execute(self, context):
        self.report({'INFO'}, "Starting export...")

        selected_meshes = [obj for obj in context.selected_objects if obj.type == 'MESH']
        if not selected_meshes:
            self.report({'WARNING'}, "No mesh objects selected.")
            return {'CANCELLED'}

        for idx, obj in enumerate(selected_meshes):
            txt_path = os.path.join(self.directory, f"Object{idx}.txt")
            try:
                with open(txt_path, 'w') as out:
                    for v in obj.data.vertices:
                        weights = []
                        for g in v.groups:
                            vg = obj.vertex_groups[g.group]
                            bone_id = bone_name_to_max_id.get(vg.name)
                            if bone_id is not None:
                                weights.append(f"{bone_id} {g.weight:.6f}")
                        out.write(" ".join(weights) + "\n")
            except Exception as e:
                self.report({'ERROR'}, f"Failed to export {obj.name}: {e}")
                continue

        self.report({'INFO'}, f"Weights exported to: {self.directory}")
        return {'FINISHED'}

# Registration function
classes = [ExportWeightsSteveAustin]

def register():
    for cls in classes:
        bpy.utils.register_class(cls)

def unregister():
    for cls in reversed(classes):
        bpy.utils.unregister_class(cls)

if __name__ == "__main__":
    register()

