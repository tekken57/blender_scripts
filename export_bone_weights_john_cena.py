import bpy
import os
from bpy_extras.io_utils import ImportHelper
from bpy.props import StringProperty

# Bone name to ID map from 3ds Max (John Cena Base)
bone_name_to_max_id = {
    "m010_0202": 0,
    "m010_0102": 1,
    "m010_0201": 2,
    "m000_0203": 3,
    "J_Head": 4,
    "J_Neck": 5,
    "J_Chest": 6,
    "m000_0103": 7,
    "J_Clavicle_L": 8,
    "m010_0101": 9,
    "m006_0103": 10,
    "m000_0303": 11,
    "m000_0302": 12,
    "H_Neck_tw": 13,
    "m010_0002": 14,
    "m006_0003": 15,
    "m010_0001": 16,
    "m010_0200": 17,
    "m009_0301": 18,
    "m000_0102": 19,
    "m000_0202": 20,
    "m000_0002": 21,
    "m009_0302": 22,
    "m009_0300": 23,
    "m010_0000": 24,
    "m006_0203": 25,
    "m010_0100": 26,
    "m009_0202": 27,
    "m006_0303": 28,
    "m012_0303": 29,
    "m012_0302": 30,
    "m000_0101": 31,
    "m000_0201": 32,
    "m000_0003": 33,
    "m000_0301": 34,
    "m030_0202": 35,
    "m030_0102": 36,
    "m030_0201": 37,
    "m012_0203": 38,
    "m030_0101": 39,
    "m029_0103": 40,
    "m012_0103": 41,
    "J_Clavicle_R": 42,
    "m030_0002": 43,
    "m029_0003": 44,
    "m030_0001": 45,
    "m012_0202": 46,
    "m012_0102": 47,
    "m030_0200": 48,
    "m013_0301": 49,
    "m013_0302": 50,
    "m012_0002": 51,
    "m013_0300": 52,
    "m030_0100": 53,
    "m030_0000": 54,
    "m029_0203": 55,
    "m029_0303": 56,
    "m013_0202": 57,
    "m012_0101": 58,
    "m012_0201": 59,
    "m012_0003": 60,
    "m012_0301": 61,
    "m009_0200": 62,
    "m002_0000": 63,
    "m001_0101": 64,
    "m001_0001": 65,
    "J_Spine2": 66,
    "m002_0100": 67,
    "m026_0001": 68,
    "m009_0100": 69,
    "H_Delt_L_OS01": 70,
    "m026_0000": 71,
    "m009_0000": 72,
    "m006_0300": 73,
    "J_Spine1": 74,
    "m001_0000": 75,
    "m007_0303": 76,
    "m006_0200": 77,
    "m007_0203": 78,
    "m007_0302": 79,
    "m001_0100": 80,
    "m002_0101": 81,
    "m002_0001": 82,
    "m000_0300": 83,
    "m000_0200": 84,
    "m001_0201": 85,
    "m026_0202": 86,
    "m009_0002": 87,
    "m006_0301": 88,
    "m026_0201": 89,
    "m006_0302": 90,
    "J_Hips": 91,
    "m001_0200": 92,
    "m012_0300": 93,
    "m006_0002": 94,
    "m006_0102": 95,
    "m006_0101": 96,
    "m006_0001": 97,
    "m006_0100": 98,
    "m006_0000": 99,
    "m007_0103": 100,
    "m007_0202": 101,
    "m007_0102": 102,
    "m007_0201": 103,
    "m007_0101": 104,
    "m007_0200": 105,
    "m007_0100": 106,
    "m000_0100": 107,
    "m000_0000": 108,
    "m000_0001": 109,
    "m009_0102": 110,
    "m006_0202": 111,
    "m006_0201": 112,
    "m026_0102": 113,
    "m007_0301": 114,
    "m007_0300": 115,
    "m026_0002": 116,
    "m004_0200": 117,
    "m004_0100": 118,
    "m004_0201": 119,
    "m026_0200": 120,
    "m026_0101": 121,
    "m026_0100": 122,
    "m028_0000": 123,
    "m014_0101": 124,
    "m014_0001": 125,
    "m013_0200": 126,
    "m027_0001": 127,
    "m013_0100": 128,
    "H_Delt_R_OS01": 129,
    "m028_0100": 130,
    "m027_0000": 131,
    "m013_0000": 132,
    "m029_0300": 133,
    "m029_0200": 134,
    "m007_0003": 135,
    "m014_0000": 136,
    "m014_0100": 137,
    "m007_0002": 138,
    "m028_0101": 139,
    "m028_0001": 140,
    "m012_0200": 141,
    "m014_0201": 142,
    "m029_0301": 143,
    "m027_0202": 144,
    "m013_0002": 145,
    "m027_0201": 146,
    "m029_0302": 147,
    "m014_0200": 148,
    "m029_0002": 149,
    "m029_0102": 150,
    "m029_0101": 151,
    "m029_0001": 152,
    "m029_0100": 153,
    "m029_0000": 154,
    "m012_0100": 155,
    "m012_0000": 156,
    "m012_0001": 157,
    "m013_0102": 158,
    "m029_0202": 159,
    "m029_0201": 160,
    "m027_0102": 161,
    "m007_0001": 162,
    "m007_0000": 163,
    "m027_0002": 164,
    "m016_0200": 165,
    "m016_0100": 166,
    "m016_0201": 167,
    "m027_0200": 168,
    "m027_0101": 169,
    "m027_0100": 170,
    "m008_0201": 171,
    "m008_0200": 172,
    "H_Ebw_In_L": 173,
    "J_Elbow_L": 174,
    "J_Shoulder_L": 175,
    "m008_0101": 176,
    "m008_0100": 177,
    "H_Elbow_L_tw02": 178,
    "H_Elbow_L_tw01": 179,
    "m008_0001": 180,
    "m008_0000": 181,
    "m003_0302": 182,
    "m003_0202": 183,
    "m003_0301": 184,
    "m008_0202": 185,
    "H_Ebw_Out_L": 186,
    "m004_0101": 187,
    "H_TrapBase_L": 188,
    "m004_0001": 189,
    "m009_0201": 190,
    "m009_0101": 191,
    "m004_0000": 192,
    "m009_0001": 193,
    "m003_0300": 194,
    "m003_0200": 195,
    "m003_0201": 196,
    "m003_0100": 197,
    "m003_0101": 198,
    "m003_0102": 199,
    "m003_0000": 200,
    "m003_0001": 201,
    "m003_0002": 202,
    "m008_0102": 203,
    "m008_0002": 204,
    "J_Wrist_L": 205,
    "m018_0201": 206,
    "m018_0200": 207,
    "H_Ebw_In_R": 208,
    "J_Elbow_R": 209,
    "J_Shoulder_R": 210,
    "m018_0101": 211,
    "m018_0100": 212,
    "m018_0001": 213,
    "m018_0000": 214,
    "H_Elbow_R_tw02": 215,
    "H_Elbow_R_tw01": 216,
    "m017_0302": 217,
    "m017_0202": 218,
    "m017_0301": 219,
    "m018_0202": 220,
    "H_Ebw_Out_R": 221,
    "m016_0101": 222,
    "H_TrapBase_R": 223,
    "m016_0001": 224,
    "m013_0201": 225,
    "m013_0101": 226,
    "m016_0000": 227,
    "m013_0001": 228,
    "m017_0300": 229,
    "m017_0200": 230,
    "m017_0201": 231,
    "m017_0100": 232,
    "m017_0101": 233,
    "m017_0102": 234,
    "m017_0000": 235,
    "m017_0001": 236,
    "m017_0002": 237,
    "m018_0102": 238,
    "m018_0002": 239,
    "J_Wrist_R": 240,
    "J_PinkyF0_L": 241,
    "J_ThumbF1_L": 242,
    "J_MiddleF0_L": 243,
    "J_RingF0_L": 244,
    "J_IndexF0_L": 245,
    "J_MiddleF1_L": 246,
    "J_RingF1_L": 247,
    "J_MiddleF3_L": 248,
    "J_IndexF1_L": 249,
    "J_MiddleF2_L": 250,
    "J_IndexF3_L": 251,
    "J_IndexF2_L": 252,
    "J_RingF3_L": 253,
    "J_PinkyF1_L": 254,
    "J_RingF2_L": 255,
    "J_PinkyF3_L": 256,
    "J_PinkyF2_L": 257,
    "J_ThumbF3_L": 258,
    "J_ThumbF2_L": 259,
    "J_PinkyF0_R": 260,
    "J_ThumbF1_R": 261,
    "J_MiddleF0_R": 262,
    "J_RingF0_R": 263,
    "J_IndexF0_R": 264,
    "J_MiddleF1_R": 265,
    "J_RingF1_R": 266,
    "J_MiddleF3_R": 267,
    "J_IndexF1_R": 268,
    "J_MiddleF2_R": 269,
    "J_IndexF3_R": 270,
    "J_IndexF2_R": 271,
    "J_RingF3_R": 272,
    "J_PinkyF1_R": 273,
    "J_RingF2_R": 274,
    "J_PinkyF3_R": 275,
    "J_PinkyF2_R": 276,
    "J_ThumbF3_R": 277,
    "J_ThumbF2_R": 278,
    "m023_0202": 279,
    "m022_0003": 280,
    "m022_0002": 281,
    "H_Leg_Vol_C_L": 282,
    "m022_0102": 283,
    "H_Hip_L_OS1": 284,
    "m023_0201": 285,
    "m022_0001": 286,
    "m022_0203": 287,
    "m022_0103": 288,
    "m022_0202": 289,
    "m015_0103": 290,
    "m015_0003": 291,
    "m015_0102": 292,
    "m015_0002": 293,
    "H_Hip_R_OS1": 294,
    "m019_0103": 295,
    "m019_0003": 296,
    "m019_0002": 297,
    "m022_0301": 298,
    "m022_0201": 299,
    "m022_0300": 300,
    "m022_0200": 301,
    "m022_0302": 302,
    "m023_0102": 303,
    "m023_0101": 304,
    "m022_0101": 305,
    "m022_0000": 306,
    "m022_0100": 307,
    "m022_0303": 308,
    "m015_0203": 309,
    "m015_0202": 310,
    "m015_0303": 311,
    "m015_0302": 312,
    "m023_0002": 313,
    "m023_0001": 314,
    "m025_0003": 315,
    "m025_0002": 316,
    "m024_0202": 317,
    "H_Leg_Vol_C_R": 318,
    "m025_0001": 319,
    "m024_0201": 320,
    "m025_0102": 321,
    "m025_0203": 322,
    "m025_0103": 323,
    "m025_0202": 324,
    "m019_0102": 325,
    "m025_0301": 326,
    "m025_0201": 327,
    "m025_0300": 328,
    "m025_0200": 329,
    "m025_0302": 330,
    "m024_0102": 331,
    "m024_0101": 332,
    "m025_0101": 333,
    "m025_0000": 334,
    "m025_0100": 335,
    "m025_0303": 336,
    "m019_0203": 337,
    "m019_0202": 338,
    "m019_0303": 339,
    "m019_0302": 340,
    "m024_0002": 341,
    "m024_0001": 342,
    "J_Foot_L": 343,
    "J_Knee_L": 344,
    "m005_0000": 345,
    "m005_0100": 346,
    "m005_0200": 347,
    "m005_0201": 348,
    "m005_0101": 349,
    "m005_0001": 350,
    "m005_0002": 351,
    "m005_0102": 352,
    "m005_0202": 353,
    "m011_0000": 354,
    "m011_0100": 355,
    "m011_0001": 356,
    "m011_0101": 357,
    "m011_0201": 358,
    "m011_0200": 359,
    "J_Leg_L": 360,
    "H_Kn_L_OS01": 361,
    "m011_0002": 362,
    "H_Kn_L_OS02": 363,
    "m011_0102": 364,
    "m011_0202": 365,
    "m015_0000": 366,
    "m015_0100": 367,
    "m015_0200": 368,
    "m015_0300": 369,
    "m015_0001": 370,
    "m015_0101": 371,
    "m015_0201": 372,
    "m015_0301": 373,
    "m023_0200": 374,
    "m023_0000": 375,
    "m023_0100": 376,
    "J_Foot_R": 377,
    "J_Knee_R": 378,
    "m021_0000": 379,
    "m021_0100": 380,
    "m021_0200": 381,
    "m021_0201": 382,
    "m021_0101": 383,
    "m021_0001": 384,
    "m021_0002": 385,
    "m021_0102": 386,
    "m021_0202": 387,
    "m020_0000": 388,
    "m020_0100": 389,
    "m020_0001": 390,
    "m020_0101": 391,
    "m020_0201": 392,
    "m020_0200": 393,
    "J_Leg_R": 394,
    "H_Kn_R_OS01": 395,
    "m020_0002": 396,
    "H_Kn_R_OS02": 397,
    "m020_0202": 398,
    "m020_0102": 399,
    "m019_0000": 400,
    "m019_0100": 401,
    "m019_0200": 402,
    "m019_0300": 403,
    "m019_0001": 404,
    "m019_0101": 405,
    "m019_0201": 406,
    "m019_0301": 407,
    "m024_0200": 408,
    "m024_0000": 409,
    "m024_0100": 410,
    "J_Toe_R": 411,
    "J_Toe_L": 412,
    "J_Eye_L": 413,
    "J_Eye_R": 414,
    "J_Jaw": 415,
    "J_Tongue3": 416,
    "J_Tongue2": 417,
    "J_Tongue1": 418,
    "J_Tongue4": 419
}

class ExportWeightsCena(bpy.types.Operator, ImportHelper):
    bl_idname = "export_weights.john_cena"
    bl_label = "Export Bone Weights (John Cena Base)"
    filename_ext = ""
    use_filter_folder = True
    directory: StringProperty(subtype='DIR_PATH')

    def execute(self, context):
        selected_meshes = [obj for obj in context.selected_objects if obj.type == 'MESH']
        if not selected_meshes:
            self.report({'WARNING'}, "No mesh objects selected.")
            return {'CANCELLED'}

        for idx, obj in enumerate(selected_meshes):
            path = os.path.join(self.directory, f"Object{idx}.txt")
            try:
                with open(path, 'w') as f:
                    for v in obj.data.vertices:
                        weights = []
                        for g in v.groups:
                            vg = obj.vertex_groups[g.group]
                            bone_id = bone_name_to_max_id.get(vg.name)
                            if bone_id is not None:
                                weights.append(f"{bone_id} {g.weight:.6f}")
                        f.write(" ".join(weights) + "\n")
            except Exception as e:
                self.report({'ERROR'}, f"Export failed for {obj.name}: {e}")
                continue

        self.report({'INFO'}, f"Export complete to: {self.directory}")
        return {'FINISHED'}

def register():
    bpy.utils.register_class(ExportWeightsCena)

def unregister():
    bpy.utils.unregister_class(ExportWeightsCena)

if __name__ == "__main__":
    register()
    bpy.ops.export_weights.john_cena('INVOKE_DEFAULT')
