import bpy
import os
import bpy.types
from bpy_extras.io_utils import ImportHelper
from bpy.props import StringProperty

# Bone name to ID map from 3ds Max
bone_name_to_max_id = {
    "J_Clavicle_L": 0,
    "H_Neck_tw": 1,
    "J_Neck": 2,
    "J_Chest": 3,
    "J_Head": 4,
    "m000_0103": 5,
    "m000_0003": 6,
    "m000_0102": 7,
    "m000_0002": 8,
    "H_Delt_L_OS01": 9,
    "m000_0302": 10,
    "m000_0202": 11,
    "m000_0201": 12,
    "m000_0101": 13,
    "m000_0301": 14,
    "m009_0301": 15,
    "J_Clavicle_R": 16,
    "m009_0103": 17,
    "m009_0003": 18,
    "m009_0002": 19,
    "m009_0102": 20,
    "H_Delt_R_OS01": 21,
    "m009_0302": 22,
    "m009_0202": 23,
    "m009_0201": 24,
    "m009_0101": 25,
    "m030_0100": 26,
    "m030_0000": 27,
    "m020_0002": 28,
    "m005_0000": 29,
    "m005_0100": 30,
    "m030_0101": 31,
    "m030_0001": 32,
    "J_Spine2": 33,
    "m028_0001": 34,
    "m020_0001": 35,
    "m028_0000": 36,
    "m004_0300": 37,
    "J_Spine1": 38,
    "J_breast_L": 39,
    "m028_0100": 40,
    "m027_0303": 41,
    "m027_0302": 42,
    "m000_0300": 43,
    "m000_0200": 44,
    "m000_0100": 45,
    "m020_0202": 46,
    "m020_0201": 47,
    "m004_0301": 48,
    "m005_0002": 49,
    "m020_0102": 50,
    "J_Hips": 51,
    "m028_0200": 52,
    "m028_0201": 53,
    "m009_0300": 54,
    "m005_0302": 55,
    "m005_0202": 56,
    "m004_0303": 57,
    "m004_0203": 58,
    "m004_0103": 59,
    "m004_0003": 60,
    "m004_0102": 61,
    "m004_0002": 62,
    "m004_0101": 63,
    "m004_0001": 64,
    "J_breast_R": 65,
    "m004_0100": 66,
    "m004_0000": 67,
    "m027_0203": 68,
    "m027_0103": 69,
    "m027_0202": 70,
    "m027_0102": 71,
    "m027_0201": 72,
    "m027_0101": 73,
    "m027_0200": 74,
    "m027_0100": 75,
    "m028_0101": 76,
    "m005_0200": 77,
    "m000_0000": 78,
    "m005_0300": 79,
    "m000_0001": 80,
    "H_TrapBase_L": 81,
    "m005_0102": 82,
    "m004_0302": 83,
    "m004_0202": 84,
    "m004_0201": 85,
    "m004_0200": 86,
    "m027_0301": 87,
    "m027_0300": 88,
    "m020_0000": 89,
    "m002_0200": 90,
    "m002_0201": 91,
    "m020_0101": 92,
    "m020_0100": 93,
    "m020_0200": 94,
    "m005_0301": 95,
    "m023_0000": 96,
    "m022_0100": 97,
    "m022_0000": 98,
    "m021_0002": 99,
    "m022_0101": 100,
    "m010_0001": 101,
    "m022_0001": 102,
    "m023_0100": 103,
    "m021_0001": 104,
    "m026_0300": 105,
    "m010_0000": 106,
    "m027_0003": 107,
    "m027_0002": 108,
    "m010_0100": 109,
    "m009_0200": 110,
    "m009_0100": 111,
    "m021_0202": 112,
    "m021_0201": 113,
    "m026_0301": 114,
    "m023_0002": 115,
    "m021_0102": 116,
    "m010_0200": 117,
    "m010_0201": 118,
    "m026_0303": 119,
    "m023_0302": 120,
    "m023_0202": 121,
    "m026_0203": 122,
    "m026_0103": 123,
    "m026_0003": 124,
    "m026_0102": 125,
    "m026_0002": 126,
    "m026_0101": 127,
    "m026_0001": 128,
    "m026_0100": 129,
    "m026_0000": 130,
    "m010_0101": 131,
    "m023_0200": 132,
    "m009_0000": 133,
    "m023_0300": 134,
    "m009_0001": 135,
    "H_TrapBase_R": 136,
    "m023_0102": 137,
    "m026_0302": 138,
    "m026_0202": 139,
    "m026_0201": 140,
    "m026_0200": 141,
    "m027_0001": 142,
    "m027_0000": 143,
    "m021_0000": 144,
    "m012_0200": 145,
    "m012_0201": 146,
    "m021_0101": 147,
    "m021_0100": 148,
    "m021_0200": 149,
    "m023_0301": 150,
    "m024_0201": 151,
    "m024_0101": 152,
    "m024_0200": 153,
    "m024_0100": 154,
    "J_Elbow_L": 155,
    "J_Shoulder_L": 156,
    "m024_0001": 157,
    "m024_0000": 158,
    "H_Elbow_L_tw02": 159,
    "H_Elbow_L_tw01": 160,
    "m001_0302": 161,
    "m001_0301": 162,
    "m024_0202": 163,
    "H_Ebw_Out_L": 164,
    "m002_0101": 165,
    "m005_0201": 166,
    "m005_0101": 167,
    "m002_0100": 168,
    "m002_0001": 169,
    "m005_0001": 170,
    "m001_0300": 171,
    "m001_0200": 172,
    "m001_0201": 173,
    "H_Ebw_In_L": 174,
    "m001_0202": 175,
    "m002_0000": 176,
    "m001_0100": 177,
    "m001_0101": 178,
    "m001_0102": 179,
    "m001_0000": 180,
    "m001_0001": 181,
    "m024_0102": 182,
    "m001_0002": 183,
    "m024_0002": 184,
    "J_Wrist_L": 185,
    "m014_0201": 186,
    "m014_0101": 187,
    "m014_0200": 188,
    "m014_0100": 189,
    "J_Elbow_R": 190,
    "J_Shoulder_R": 191,
    "m014_0001": 192,
    "m014_0000": 193,
    "H_Elbow_R_tw02": 194,
    "H_Elbow_R_tw01": 195,
    "m013_0302": 196,
    "m013_0301": 197,
    "m014_0202": 198,
    "H_Ebw_Out_R": 199,
    "m012_0101": 200,
    "m023_0201": 201,
    "m023_0101": 202,
    "m012_0100": 203,
    "m012_0001": 204,
    "m023_0001": 205,
    "m013_0300": 206,
    "m013_0200": 207,
    "m013_0201": 208,
    "m013_0202": 209,
    "H_Ebw_In_R": 210,
    "m012_0000": 211,
    "m013_0100": 212,
    "m013_0101": 213,
    "m013_0102": 214,
    "m013_0000": 215,
    "m013_0001": 216,
    "m013_0002": 217,
    "m014_0102": 218,
    "m014_0002": 219,
    "J_Wrist_R": 220,
    "J_PinkyF0_L": 221,
    "J_ThumbF1_L": 222,
    "J_RingF0_L": 223,
    "J_MiddleF0_L": 224,
    "J_IndexF0_L": 225,
    "J_MiddleF1_L": 226,
    "J_RingF1_L": 227,
    "J_MiddleF3_L": 228,
    "J_IndexF1_L": 229,
    "J_MiddleF2_L": 230,
    "J_IndexF3_L": 231,
    "J_IndexF2_L": 232,
    "J_RingF3_L": 233,
    "J_PinkyF1_L": 234,
    "J_RingF2_L": 235,
    "J_PinkyF3_L": 236,
    "J_PinkyF2_L": 237,
    "J_ThumbF3_L": 238,
    "J_ThumbF2_L": 239,
    "J_PinkyF0_R": 240,
    "J_ThumbF1_R": 241,
    "J_MiddleF0_R": 242,
    "J_RingF0_R": 243,
    "J_IndexF0_R": 244,
    "J_MiddleF1_R": 245,
    "J_RingF1_R": 246,
    "J_MiddleF3_R": 247,
    "J_IndexF1_R": 248,
    "J_MiddleF2_R": 249,
    "J_IndexF3_R": 250,
    "J_IndexF2_R": 251,
    "J_RingF3_R": 252,
    "J_PinkyF1_R": 253,
    "J_RingF2_R": 254,
    "J_PinkyF3_R": 255,
    "J_PinkyF2_R": 256,
    "J_ThumbF3_R": 257,
    "J_ThumbF2_R": 258,
    "m029_0202": 259,
    "m017_0102": 260,
    "m017_0002": 261,
    "m017_0001": 262,
    "H_Leg_Vol_C_L": 263,
    "H_Hip_L_OS1": 264,
    "m017_0103": 265,
    "m017_0003": 266,
    "m029_0201": 267,
    "m017_0101": 268,
    "m017_0203": 269,
    "m017_0202": 270,
    "m017_0201": 271,
    "m011_0003": 272,
    "m011_0002": 273,
    "m011_0103": 274,
    "m011_0102": 275,
    "m025_0003": 276,
    "H_Hip_R_OS1": 277,
    "m017_0302": 278,
    "m017_0301": 279,
    "m017_0300": 280,
    "m017_0200": 281,
    "m029_0200": 282,
    "m017_0000": 283,
    "m029_0101": 284,
    "m011_0302": 285,
    "m011_0301": 286,
    "m017_0100": 287,
    "m017_0303": 288,
    "m011_0203": 289,
    "m011_0202": 290,
    "m011_0303": 291,
    "m029_0002": 292,
    "m029_0001": 293,
    "m029_0102": 294,
    "m019_0102": 295,
    "m019_0002": 296,
    "m019_0001": 297,
    "m018_0202": 298,
    "H_Leg_Vol_C_R": 299,
    "m019_0103": 300,
    "m019_0003": 301,
    "m018_0201": 302,
    "m019_0101": 303,
    "m019_0203": 304,
    "m019_0202": 305,
    "m019_0201": 306,
    "m025_0002": 307,
    "m025_0103": 308,
    "m025_0102": 309,
    "m019_0302": 310,
    "m019_0301": 311,
    "m019_0300": 312,
    "m019_0200": 313,
    "m019_0000": 314,
    "m018_0200": 315,
    "m025_0302": 316,
    "m018_0101": 317,
    "m025_0301": 318,
    "m019_0100": 319,
    "m019_0303": 320,
    "m025_0203": 321,
    "m025_0202": 322,
    "m025_0303": 323,
    "m018_0002": 324,
    "m018_0001": 325,
    "m018_0102": 326,
    "J_Foot_L": 327,
    "J_Knee_L": 328,
    "m003_0100": 329,
    "m003_0000": 330,
    "m003_0200": 331,
    "m003_0201": 332,
    "m003_0101": 333,
    "m003_0001": 334,
    "m003_0002": 335,
    "m003_0102": 336,
    "m003_0202": 337,
    "m007_0200": 338,
    "m007_0000": 339,
    "m007_0001": 340,
    "m007_0101": 341,
    "m007_0100": 342,
    "m007_0201": 343,
    "J_Leg_L": 344,
    "H_Kn_L_OS01": 345,
    "H_Kn_L_OS02": 346,
    "m007_0102": 347,
    "m007_0002": 348,
    "m007_0202": 349,
    "m011_0000": 350,
    "m011_0100": 351,
    "m011_0200": 352,
    "m011_0300": 353,
    "m011_0001": 354,
    "m011_0101": 355,
    "m011_0201": 356,
    "m029_0000": 357,
    "m029_0100": 358,
    "J_Foot_R": 359,
    "J_Knee_R": 360,
    "m016_0100": 361,
    "m016_0000": 362,
    "m016_0200": 363,
    "m016_0201": 364,
    "m016_0101": 365,
    "m016_0001": 366,
    "m016_0002": 367,
    "m016_0102": 368,
    "m016_0202": 369,
    "m015_0200": 370,
    "m015_0000": 371,
    "m015_0101": 372,
    "m015_0001": 373,
    "m015_0100": 374,
    "m015_0201": 375,
    "J_Leg_R": 376,
    "H_Kn_R_OS01": 377,
    "H_Kn_R_OS02": 378,
    "m015_0202": 379,
    "m015_0102": 380,
    "m015_0002": 381,
    "m025_0000": 382,
    "m025_0100": 383,
    "m025_0200": 384,
    "m025_0300": 385,
    "m025_0001": 386,
    "m025_0101": 387,
    "m025_0201": 388,
    "m018_0000": 389,
    "m018_0100": 390,
    "J_Toe_R": 391,
    "J_Toe_L": 392,
    "J_Eye_L": 393,
    "J_Eye_R": 394,
    "J_Jaw": 395,
    "J_Tongue3": 396,
    "J_Tongue2": 397,
    "J_Tongue1": 398,
    "J_Tongue4": 399
}

class ExportCharlotteWeights(bpy.types.Operator, ImportHelper):
    """Export Charlotte Flair Bone Weights"""
    bl_idname = "export_weights.charlotte_flair"
    bl_label = "Export Bone Weights (Charlotte Flair Base)"
    filename_ext = ""
    use_filter_folder = True
    directory: StringProperty(subtype='DIR_PATH')

    def execute(self, context):
        self.report({'INFO'}, "Starting Charlotte Flair weight export...")

        selected_meshes = [obj for obj in context.selected_objects if obj.type == 'MESH']
        if not selected_meshes:
            self.report({'WARNING'}, "No mesh objects selected.")
            return {'CANCELLED'}

        for idx, obj in enumerate(selected_meshes):
            txt_path = os.path.join(self.directory, f"Object{idx}.txt")
            try:
                with open(txt_path, 'w') as out:
                    for v in obj.data.vertices:
                        weights = []
                        for g in v.groups:
                            vg = obj.vertex_groups[g.group]
                            bone_id = bone_name_to_max_id.get(vg.name)
                            if bone_id is not None:
                                weights.append(f"{bone_id} {g.weight:.6f}")
                        out.write(" ".join(weights) + "\n")
            except Exception as e:
                self.report({'ERROR'}, f"Failed to export {obj.name}: {e}")
                continue

        self.report({'INFO'}, f"Weights exported to: {self.directory}")
        return {'FINISHED'}

classes = [ExportCharlotteWeights]

def register():
    for cls in classes:
        bpy.utils.register_class(cls)

def unregister():
    for cls in reversed(classes):
        bpy.utils.unregister_class(cls)

if __name__ == "__main__":
    register()
